(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const Et="modulepreload",Tt=function(n){return"/"+n},je={},X=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let a=function(c){return Promise.all(c.map(h=>Promise.resolve(h).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));i=a(t.map(c=>{if(c=Tt(c),c in je)return;je[c]=!0;const h=c.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":Et,h||(u.as="script"),u.crossOrigin="",u.href=c,l&&u.setAttribute("nonce",l),document.head.appendChild(u),h)return new Promise((f,p)=>{u.addEventListener("load",f),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return i.then(a=>{for(const o of a||[])o.status==="rejected"&&r(o.reason);return e().catch(r)})},St=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>X(async()=>{const{default:s}=await Promise.resolve().then(()=>Z);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)};class xe extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class It extends xe{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Pt extends xe{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Ct extends xe{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var be;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(be||(be={}));var xt=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};class At{constructor(e,{headers:t={},customFetch:s,region:i=be.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=St(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var s;return xt(this,void 0,void 0,function*(){try{const{headers:i,method:r,body:a}=t;let o={},{region:l}=t;l||(l=this.region),l&&l!=="any"&&(o["x-region"]=l);let c;a&&(i&&!Object.prototype.hasOwnProperty.call(i,"Content-Type")||!i)&&(typeof Blob<"u"&&a instanceof Blob||a instanceof ArrayBuffer?(o["Content-Type"]="application/octet-stream",c=a):typeof a=="string"?(o["Content-Type"]="text/plain",c=a):typeof FormData<"u"&&a instanceof FormData?c=a:(o["Content-Type"]="application/json",c=JSON.stringify(a)));const h=yield this.fetch(`${this.url}/${e}`,{method:r||"POST",headers:Object.assign(Object.assign(Object.assign({},o),this.headers),i),body:c}).catch(p=>{throw new It(p)}),d=h.headers.get("x-relay-error");if(d&&d==="true")throw new Pt(h);if(!h.ok)throw new Ct(h);let u=((s=h.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),f;return u==="application/json"?f=yield h.json():u==="application/octet-stream"?f=yield h.blob():u==="text/event-stream"?f=h:u==="multipart/form-data"?f=yield h.formData():f=yield h.text(),{data:f,error:null}}catch(i){return{data:null,error:i}}})}}function Lt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function Ot(n){if(Object.prototype.hasOwnProperty.call(n,"__esModule"))return n;var e=n.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(s){var i=Object.getOwnPropertyDescriptor(n,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return n[s]}})}),t}var k={},q={},V={},F={},H={},z={},$t=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Q=$t();const jt=Q.fetch,rt=Q.fetch.bind(Q),nt=Q.Headers,Rt=Q.Request,Ut=Q.Response,Z=Object.freeze(Object.defineProperty({__proto__:null,Headers:nt,Request:Rt,Response:Ut,default:rt,fetch:jt},Symbol.toStringTag,{value:"Module"})),Dt=Ot(Z);var le={},Re;function at(){if(Re)return le;Re=1,Object.defineProperty(le,"__esModule",{value:!0});class n extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return le.default=n,le}var Ue;function ot(){if(Ue)return z;Ue=1;var n=z&&z.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(z,"__esModule",{value:!0});const e=n(Dt),t=n(at());class s{constructor(r){this.shouldThrowOnError=!1,this.method=r.method,this.url=r.url,this.headers=r.headers,this.schema=r.schema,this.body=r.body,this.shouldThrowOnError=r.shouldThrowOnError,this.signal=r.signal,this.isMaybeSingle=r.isMaybeSingle,r.fetch?this.fetch=r.fetch:typeof fetch>"u"?this.fetch=e.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(r,a){return this.headers=Object.assign({},this.headers),this.headers[r]=a,this}then(r,a){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const o=this.fetch;let l=o(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async c=>{var h,d,u;let f=null,p=null,y=null,g=c.status,b=c.statusText;if(c.ok){if(this.method!=="HEAD"){const S=await c.text();S===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?p=S:p=JSON.parse(S))}const _=(h=this.headers.Prefer)===null||h===void 0?void 0:h.match(/count=(exact|planned|estimated)/),T=(d=c.headers.get("content-range"))===null||d===void 0?void 0:d.split("/");_&&T&&T.length>1&&(y=parseInt(T[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(p)&&(p.length>1?(f={code:"PGRST116",details:`Results contain ${p.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},p=null,y=null,g=406,b="Not Acceptable"):p.length===1?p=p[0]:p=null)}else{const _=await c.text();try{f=JSON.parse(_),Array.isArray(f)&&c.status===404&&(p=[],f=null,g=200,b="OK")}catch{c.status===404&&_===""?(g=204,b="No Content"):f={message:_}}if(f&&this.isMaybeSingle&&(!((u=f==null?void 0:f.details)===null||u===void 0)&&u.includes("0 rows"))&&(f=null,g=200,b="OK"),f&&this.shouldThrowOnError)throw new t.default(f)}return{error:f,data:p,count:y,status:g,statusText:b}});return this.shouldThrowOnError||(l=l.catch(c=>{var h,d,u;return{error:{message:`${(h=c==null?void 0:c.name)!==null&&h!==void 0?h:"FetchError"}: ${c==null?void 0:c.message}`,details:`${(d=c==null?void 0:c.stack)!==null&&d!==void 0?d:""}`,hint:"",code:`${(u=c==null?void 0:c.code)!==null&&u!==void 0?u:""}`},data:null,count:null,status:0,statusText:""}})),l.then(r,a)}returns(){return this}overrideTypes(){return this}}return z.default=s,z}var De;function lt(){if(De)return H;De=1;var n=H&&H.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(H,"__esModule",{value:!0});const e=n(ot());class t extends e.default{select(i){let r=!1;const a=(i??"*").split("").map(o=>/\s/.test(o)&&!r?"":(o==='"'&&(r=!r),o)).join("");return this.url.searchParams.set("select",a),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(i,{ascending:r=!0,nullsFirst:a,foreignTable:o,referencedTable:l=o}={}){const c=l?`${l}.order`:"order",h=this.url.searchParams.get(c);return this.url.searchParams.set(c,`${h?`${h},`:""}${i}.${r?"asc":"desc"}${a===void 0?"":a?".nullsfirst":".nullslast"}`),this}limit(i,{foreignTable:r,referencedTable:a=r}={}){const o=typeof a>"u"?"limit":`${a}.limit`;return this.url.searchParams.set(o,`${i}`),this}range(i,r,{foreignTable:a,referencedTable:o=a}={}){const l=typeof o>"u"?"offset":`${o}.offset`,c=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(l,`${i}`),this.url.searchParams.set(c,`${r-i+1}`),this}abortSignal(i){return this.signal=i,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:i=!1,verbose:r=!1,settings:a=!1,buffers:o=!1,wal:l=!1,format:c="text"}={}){var h;const d=[i?"analyze":null,r?"verbose":null,a?"settings":null,o?"buffers":null,l?"wal":null].filter(Boolean).join("|"),u=(h=this.headers.Accept)!==null&&h!==void 0?h:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${c}; for="${u}"; options=${d};`,c==="json"?this:this}rollback(){var i;return((i=this.headers.Prefer)!==null&&i!==void 0?i:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}return H.default=t,H}var Be;function Ae(){if(Be)return F;Be=1;var n=F&&F.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(F,"__esModule",{value:!0});const e=n(lt());class t extends e.default{eq(i,r){return this.url.searchParams.append(i,`eq.${r}`),this}neq(i,r){return this.url.searchParams.append(i,`neq.${r}`),this}gt(i,r){return this.url.searchParams.append(i,`gt.${r}`),this}gte(i,r){return this.url.searchParams.append(i,`gte.${r}`),this}lt(i,r){return this.url.searchParams.append(i,`lt.${r}`),this}lte(i,r){return this.url.searchParams.append(i,`lte.${r}`),this}like(i,r){return this.url.searchParams.append(i,`like.${r}`),this}likeAllOf(i,r){return this.url.searchParams.append(i,`like(all).{${r.join(",")}}`),this}likeAnyOf(i,r){return this.url.searchParams.append(i,`like(any).{${r.join(",")}}`),this}ilike(i,r){return this.url.searchParams.append(i,`ilike.${r}`),this}ilikeAllOf(i,r){return this.url.searchParams.append(i,`ilike(all).{${r.join(",")}}`),this}ilikeAnyOf(i,r){return this.url.searchParams.append(i,`ilike(any).{${r.join(",")}}`),this}is(i,r){return this.url.searchParams.append(i,`is.${r}`),this}in(i,r){const a=Array.from(new Set(r)).map(o=>typeof o=="string"&&new RegExp("[,()]").test(o)?`"${o}"`:`${o}`).join(",");return this.url.searchParams.append(i,`in.(${a})`),this}contains(i,r){return typeof r=="string"?this.url.searchParams.append(i,`cs.${r}`):Array.isArray(r)?this.url.searchParams.append(i,`cs.{${r.join(",")}}`):this.url.searchParams.append(i,`cs.${JSON.stringify(r)}`),this}containedBy(i,r){return typeof r=="string"?this.url.searchParams.append(i,`cd.${r}`):Array.isArray(r)?this.url.searchParams.append(i,`cd.{${r.join(",")}}`):this.url.searchParams.append(i,`cd.${JSON.stringify(r)}`),this}rangeGt(i,r){return this.url.searchParams.append(i,`sr.${r}`),this}rangeGte(i,r){return this.url.searchParams.append(i,`nxl.${r}`),this}rangeLt(i,r){return this.url.searchParams.append(i,`sl.${r}`),this}rangeLte(i,r){return this.url.searchParams.append(i,`nxr.${r}`),this}rangeAdjacent(i,r){return this.url.searchParams.append(i,`adj.${r}`),this}overlaps(i,r){return typeof r=="string"?this.url.searchParams.append(i,`ov.${r}`):this.url.searchParams.append(i,`ov.{${r.join(",")}}`),this}textSearch(i,r,{config:a,type:o}={}){let l="";o==="plain"?l="pl":o==="phrase"?l="ph":o==="websearch"&&(l="w");const c=a===void 0?"":`(${a})`;return this.url.searchParams.append(i,`${l}fts${c}.${r}`),this}match(i){return Object.entries(i).forEach(([r,a])=>{this.url.searchParams.append(r,`eq.${a}`)}),this}not(i,r,a){return this.url.searchParams.append(i,`not.${r}.${a}`),this}or(i,{foreignTable:r,referencedTable:a=r}={}){const o=a?`${a}.or`:"or";return this.url.searchParams.append(o,`(${i})`),this}filter(i,r,a){return this.url.searchParams.append(i,`${r}.${a}`),this}}return F.default=t,F}var Me;function ht(){if(Me)return V;Me=1;var n=V&&V.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(V,"__esModule",{value:!0});const e=n(Ae());class t{constructor(i,{headers:r={},schema:a,fetch:o}){this.url=i,this.headers=r,this.schema=a,this.fetch=o}select(i,{head:r=!1,count:a}={}){const o=r?"HEAD":"GET";let l=!1;const c=(i??"*").split("").map(h=>/\s/.test(h)&&!l?"":(h==='"'&&(l=!l),h)).join("");return this.url.searchParams.set("select",c),a&&(this.headers.Prefer=`count=${a}`),new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(i,{count:r,defaultToNull:a=!0}={}){const o="POST",l=[];if(this.headers.Prefer&&l.push(this.headers.Prefer),r&&l.push(`count=${r}`),a||l.push("missing=default"),this.headers.Prefer=l.join(","),Array.isArray(i)){const c=i.reduce((h,d)=>h.concat(Object.keys(d)),[]);if(c.length>0){const h=[...new Set(c)].map(d=>`"${d}"`);this.url.searchParams.set("columns",h.join(","))}}return new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}upsert(i,{onConflict:r,ignoreDuplicates:a=!1,count:o,defaultToNull:l=!0}={}){const c="POST",h=[`resolution=${a?"ignore":"merge"}-duplicates`];if(r!==void 0&&this.url.searchParams.set("on_conflict",r),this.headers.Prefer&&h.push(this.headers.Prefer),o&&h.push(`count=${o}`),l||h.push("missing=default"),this.headers.Prefer=h.join(","),Array.isArray(i)){const d=i.reduce((u,f)=>u.concat(Object.keys(f)),[]);if(d.length>0){const u=[...new Set(d)].map(f=>`"${f}"`);this.url.searchParams.set("columns",u.join(","))}}return new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}update(i,{count:r}={}){const a="PATCH",o=[];return this.headers.Prefer&&o.push(this.headers.Prefer),r&&o.push(`count=${r}`),this.headers.Prefer=o.join(","),new e.default({method:a,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}delete({count:i}={}){const r="DELETE",a=[];return i&&a.push(`count=${i}`),this.headers.Prefer&&a.unshift(this.headers.Prefer),this.headers.Prefer=a.join(","),new e.default({method:r,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}return V.default=t,V}var ee={},te={},Ne;function Bt(){return Ne||(Ne=1,Object.defineProperty(te,"__esModule",{value:!0}),te.version=void 0,te.version="0.0.0-automated"),te}var qe;function Mt(){if(qe)return ee;qe=1,Object.defineProperty(ee,"__esModule",{value:!0}),ee.DEFAULT_HEADERS=void 0;const n=Bt();return ee.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${n.version}`},ee}var Ve;function Nt(){if(Ve)return q;Ve=1;var n=q&&q.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(q,"__esModule",{value:!0});const e=n(ht()),t=n(Ae()),s=Mt();class i{constructor(a,{headers:o={},schema:l,fetch:c}={}){this.url=a,this.headers=Object.assign(Object.assign({},s.DEFAULT_HEADERS),o),this.schemaName=l,this.fetch=c}from(a){const o=new URL(`${this.url}/${a}`);return new e.default(o,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(a){return new i(this.url,{headers:this.headers,schema:a,fetch:this.fetch})}rpc(a,o={},{head:l=!1,get:c=!1,count:h}={}){let d;const u=new URL(`${this.url}/rpc/${a}`);let f;l||c?(d=l?"HEAD":"GET",Object.entries(o).filter(([y,g])=>g!==void 0).map(([y,g])=>[y,Array.isArray(g)?`{${g.join(",")}}`:`${g}`]).forEach(([y,g])=>{u.searchParams.append(y,g)})):(d="POST",f=o);const p=Object.assign({},this.headers);return h&&(p.Prefer=`count=${h}`),new t.default({method:d,url:u,headers:p,schema:this.schemaName,body:f,fetch:this.fetch,allowEmpty:!1})}}return q.default=i,q}var Fe;function qt(){if(Fe)return k;Fe=1;var n=k&&k.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(k,"__esModule",{value:!0}),k.PostgrestError=k.PostgrestBuilder=k.PostgrestTransformBuilder=k.PostgrestFilterBuilder=k.PostgrestQueryBuilder=k.PostgrestClient=void 0;const e=n(Nt());k.PostgrestClient=e.default;const t=n(ht());k.PostgrestQueryBuilder=t.default;const s=n(Ae());k.PostgrestFilterBuilder=s.default;const i=n(lt());k.PostgrestTransformBuilder=i.default;const r=n(ot());k.PostgrestBuilder=r.default;const a=n(at());return k.PostgrestError=a.default,k.default={PostgrestClient:e.default,PostgrestQueryBuilder:t.default,PostgrestFilterBuilder:s.default,PostgrestTransformBuilder:i.default,PostgrestBuilder:r.default,PostgrestError:a.default},k}var Vt=qt();const Ft=Lt(Vt),{PostgrestClient:Ht,PostgrestQueryBuilder:xi,PostgrestFilterBuilder:Ai,PostgrestTransformBuilder:Li,PostgrestBuilder:Oi,PostgrestError:$i}=Ft,zt="2.11.2",Jt={"X-Client-Info":`realtime-js/${zt}`},Kt="1.0.0",ct=1e4,Wt=1e3;var Y;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(Y||(Y={}));var C;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(C||(C={}));var x;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(x||(x={}));var ke;(function(n){n.websocket="websocket"})(ke||(ke={}));var M;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(M||(M={}));class Gt{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const i=t.getUint8(1),r=t.getUint8(2);let a=this.HEADER_LENGTH+2;const o=s.decode(e.slice(a,a+i));a=a+i;const l=s.decode(e.slice(a,a+r));a=a+r;const c=JSON.parse(s.decode(e.slice(a,e.byteLength)));return{ref:null,topic:o,event:l,payload:c}}}class dt{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var w;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(w||(w={}));const He=(n,e,t={})=>{var s;const i=(s=t.skipTypes)!==null&&s!==void 0?s:[];return Object.keys(e).reduce((r,a)=>(r[a]=Yt(a,n,e,i),r),{})},Yt=(n,e,t,s)=>{const i=e.find(o=>o.name===n),r=i==null?void 0:i.type,a=t[n];return r&&!s.includes(r)?ut(r,a):Ee(a)},ut=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return es(e,t)}switch(n){case w.bool:return Xt(e);case w.float4:case w.float8:case w.int2:case w.int4:case w.int8:case w.numeric:case w.oid:return Qt(e);case w.json:case w.jsonb:return Zt(e);case w.timestamp:return ts(e);case w.abstime:case w.date:case w.daterange:case w.int4range:case w.int8range:case w.money:case w.reltime:case w.text:case w.time:case w.timestamptz:case w.timetz:case w.tsrange:case w.tstzrange:return Ee(e);default:return Ee(e)}},Ee=n=>n,Xt=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Qt=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Zt=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch(e){return console.log(`JSON parse error: ${e}`),n}return n},es=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,s=n[t];if(n[0]==="{"&&s==="}"){let r;const a=n.slice(1,t);try{r=JSON.parse("["+a+"]")}catch{r=a?a.split(","):[]}return r.map(o=>ut(e,o))}return n},ts=n=>typeof n=="string"?n.replace(" ","T"):n,ft=n=>{let e=n;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class ge{constructor(e,t,s={},i=ct){this.channel=e,this.event=t,this.payload=s,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var ze;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(ze||(ze={}));class ie{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},i=>{const{onJoin:r,onLeave:a,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=ie.syncState(this.state,i,r,a),this.pendingDiffs.forEach(l=>{this.state=ie.syncDiff(this.state,l,r,a)}),this.pendingDiffs=[],o()}),this.channel._on(s.diff,{},i=>{const{onJoin:r,onLeave:a,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=ie.syncDiff(this.state,i,r,a),o())}),this.onJoin((i,r,a)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:r,newPresences:a})}),this.onLeave((i,r,a)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:r,leftPresences:a})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,i){const r=this.cloneDeep(e),a=this.transformState(t),o={},l={};return this.map(r,(c,h)=>{a[c]||(l[c]=h)}),this.map(a,(c,h)=>{const d=r[c];if(d){const u=h.map(g=>g.presence_ref),f=d.map(g=>g.presence_ref),p=h.filter(g=>f.indexOf(g.presence_ref)<0),y=d.filter(g=>u.indexOf(g.presence_ref)<0);p.length>0&&(o[c]=p),y.length>0&&(l[c]=y)}else o[c]=h}),this.syncDiff(r,{joins:o,leaves:l},s,i)}static syncDiff(e,t,s,i){const{joins:r,leaves:a}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),i||(i=()=>{}),this.map(r,(o,l)=>{var c;const h=(c=e[o])!==null&&c!==void 0?c:[];if(e[o]=this.cloneDeep(l),h.length>0){const d=e[o].map(f=>f.presence_ref),u=h.filter(f=>d.indexOf(f.presence_ref)<0);e[o].unshift(...u)}s(o,h,l)}),this.map(a,(o,l)=>{let c=e[o];if(!c)return;const h=l.map(d=>d.presence_ref);c=c.filter(d=>h.indexOf(d.presence_ref)<0),e[o]=c,i(o,c,l),c.length===0&&delete e[o]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const i=e[s];return"metas"in i?t[s]=i.metas.map(r=>(r.presence_ref=r.phx_ref,delete r.phx_ref,delete r.phx_ref_prev,r)):t[s]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Je;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(Je||(Je={}));var Ke;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(Ke||(Ke={}));var L;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(L||(L={}));class Le{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=C.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new ge(this,x.join,this.params,this.timeout),this.rejoinTimer=new dt(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=C.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=C.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=C.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=C.errored,this.rejoinTimer.scheduleTimeout())}),this._on(x.reply,{},(i,r)=>{this._trigger(this._replyEventName(r),i)}),this.presence=new ie(this),this.broadcastEndpointURL=ft(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var s,i;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:r,presence:a,private:o}}=this.params;this._onError(h=>e==null?void 0:e(L.CHANNEL_ERROR,h)),this._onClose(()=>e==null?void 0:e(L.CLOSED));const l={},c={broadcast:r,presence:a,postgres_changes:(i=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(h=>h.filter))!==null&&i!==void 0?i:[],private:o};this.socket.accessTokenValue&&(l.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:c},l)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:h})=>{var d;if(this.socket.setAuth(),h===void 0){e==null||e(L.SUBSCRIBED);return}else{const u=this.bindings.postgres_changes,f=(d=u==null?void 0:u.length)!==null&&d!==void 0?d:0,p=[];for(let y=0;y<f;y++){const g=u[y],{filter:{event:b,schema:P,table:_,filter:T}}=g,S=h&&h[y];if(S&&S.event===b&&S.schema===P&&S.table===_&&S.filter===T)p.push(Object.assign(Object.assign({},g),{id:S.id}));else{this.unsubscribe(),e==null||e(L.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=p,e&&e(L.SUBSCRIBED);return}}).receive("error",h=>{e==null||e(L.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(h).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(L.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this._on(e,t,s)}async send(e,t={}){var s,i;if(!this._canPush()&&e.type==="broadcast"){const{event:r,payload:a}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:r,payload:a,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(s=t.timeout)!==null&&s!==void 0?s:this.timeout);return await((i=c.body)===null||i===void 0?void 0:i.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(r=>{var a,o,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(o=(a=this.params)===null||a===void 0?void 0:a.config)===null||o===void 0?void 0:o.broadcast)===null||l===void 0)&&l.ack)&&r("ok"),c.receive("ok",()=>r("ok")),c.receive("error",()=>r("error")),c.receive("timeout",()=>r("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=C.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(x.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(s=>{const i=new ge(this,x.leave,{},e);i.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),i.send(),this._canPush()||i.trigger("ok",{})})}async _fetchWithTimeout(e,t,s){const i=new AbortController,r=setTimeout(()=>i.abort(),s),a=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(r),a}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new ge(this,e,t,s);return this._canPush()?i.send():(i.startTimeout(),this.pushBuffer.push(i)),i}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var i,r;const a=e.toLocaleLowerCase(),{close:o,error:l,leave:c,join:h}=x;if(s&&[o,l,c,h].indexOf(a)>=0&&s!==this._joinRef())return;let u=this._onMessage(a,t,s);if(t&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(a)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(f=>{var p,y,g;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((g=(y=f.filter)===null||y===void 0?void 0:y.event)===null||g===void 0?void 0:g.toLocaleLowerCase())===a}).map(f=>f.callback(u,s)):(r=this.bindings[a])===null||r===void 0||r.filter(f=>{var p,y,g,b,P,_;if(["broadcast","presence","postgres_changes"].includes(a))if("id"in f){const T=f.id,S=(p=f.filter)===null||p===void 0?void 0:p.event;return T&&((y=t.ids)===null||y===void 0?void 0:y.includes(T))&&(S==="*"||(S==null?void 0:S.toLocaleLowerCase())===((g=t.data)===null||g===void 0?void 0:g.type.toLocaleLowerCase()))}else{const T=(P=(b=f==null?void 0:f.filter)===null||b===void 0?void 0:b.event)===null||P===void 0?void 0:P.toLocaleLowerCase();return T==="*"||T===((_=t==null?void 0:t.event)===null||_===void 0?void 0:_.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===a}).map(f=>{if(typeof u=="object"&&"ids"in u){const p=u.data,{schema:y,table:g,commit_timestamp:b,type:P,errors:_}=p;u=Object.assign(Object.assign({},{schema:y,table:g,commit_timestamp:b,eventType:P,new:{},old:{},errors:_}),this._getPayloadRecords(p))}f.callback(u,s)})}_isClosed(){return this.state===C.closed}_isJoined(){return this.state===C.joined}_isJoining(){return this.state===C.joining}_isLeaving(){return this.state===C.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const i=e.toLocaleLowerCase(),r={type:i,filter:t,callback:s};return this.bindings[i]?this.bindings[i].push(r):this.bindings[i]=[r],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]=this.bindings[s].filter(i=>{var r;return!(((r=i.type)===null||r===void 0?void 0:r.toLocaleLowerCase())===s&&Le.isEqual(i.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(x.close,{},e)}_onError(e){this._on(x.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=C.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=He(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=He(e.columns,e.old_record)),t}}const ss=()=>{},is=typeof WebSocket<"u",rs=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class ns{constructor(e,t){var s;this.accessTokenValue=null,this.apiKey=null,this.channels=[],this.endPoint="",this.httpEndpoint="",this.headers=Jt,this.params={},this.timeout=ct,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=ss,this.conn=null,this.sendBuffer=[],this.serializer=new Gt,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=r=>{let a;return r?a=r:typeof fetch>"u"?a=(...o)=>X(async()=>{const{default:l}=await Promise.resolve().then(()=>Z);return{default:l}},void 0).then(({default:l})=>l(...o)):a=fetch,(...o)=>a(...o)},this.endPoint=`${e}/${ke.websocket}`,this.httpEndpoint=ft(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const i=(s=t==null?void 0:t.params)===null||s===void 0?void 0:s.apikey;if(i&&(this.accessTokenValue=i,this.apiKey=i),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:r=>[1e3,2e3,5e3,1e4][r-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(r,a)=>a(JSON.stringify(r)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new dt(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this.endpointURL(),void 0,{headers:this.headers});return}if(is){this.conn=new WebSocket(this.endpointURL()),this.setupConnection();return}this.conn=new as(this.endpointURL(),void 0,{close:()=>{this.conn=null}}),X(async()=>{const{default:e}=await import("./browser-DpVMQivM.js").then(t=>t.b);return{default:e}},[]).then(({default:e})=>{this.conn=new e(this.endpointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:Kt}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case Y.connecting:return M.Connecting;case Y.open:return M.Open;case Y.closing:return M.Closing;default:return M.Closed}}isConnected(){return this.connectionState()===M.Open}channel(e,t={config:{}}){const s=new Le(`realtime:${e}`,t,this);return this.channels.push(s),s}push(e){const{topic:t,event:s,payload:i,ref:r}=e,a=()=>{this.encode(e,o=>{var l;(l=this.conn)===null||l===void 0||l.send(o)})};this.log("push",`${t} ${s} (${r})`,i),this.isConnected()?a():this.sendBuffer.push(a)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;if(t){let s=null;try{s=JSON.parse(atob(t.split(".")[1]))}catch{}if(s&&s.exp&&!(Math.floor(Date.now()/1e3)-s.exp<0))return this.log("auth",`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${s.exp}`),Promise.reject(`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${s.exp}`);this.accessTokenValue=t,this.channels.forEach(i=>{t&&i.updateJoinPayload({access_token:t}),i.joinedOnce&&i._isJoined()&&i._push(x.access_token,{access_token:t})})}}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(Wt,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth()}}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:s,event:i,payload:r,ref:a}=t;a&&a===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${r.status||""} ${s} ${i} ${a&&"("+a+")"||""}`,r),this.channels.filter(o=>o._isMember(s)).forEach(o=>o._trigger(i,r,a)),this.stateChangeCallbacks.message.forEach(o=>o(t))})}async _onConnOpen(){if(this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),!this.worker)this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs);else{this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(x.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const s=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${s}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const s=new Blob([rs],{type:"application/javascript"});t=URL.createObjectURL(s)}return t}}class as{constructor(e,t,s){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=Y.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=s.close}}class Oe extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function E(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}class os extends Oe{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Te extends Oe{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var ls=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};const pt=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>X(async()=>{const{default:s}=await Promise.resolve().then(()=>Z);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)},hs=()=>ls(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield X(()=>Promise.resolve().then(()=>Z),void 0)).Response:Response}),Se=n=>{if(Array.isArray(n))return n.map(t=>Se(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,s])=>{const i=t.replace(/([-_][a-z])/gi,r=>r.toUpperCase().replace(/[-_]/g,""));e[i]=Se(s)}),e};var N=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};const me=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),cs=(n,e,t)=>N(void 0,void 0,void 0,function*(){const s=yield hs();n instanceof s&&!(t!=null&&t.noResolveJson)?n.json().then(i=>{e(new os(me(i),n.status||500))}).catch(i=>{e(new Te(me(i),i))}):e(new Te(me(n),n))}),ds=(n,e,t,s)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),s&&(i.body=JSON.stringify(s)),Object.assign(Object.assign({},i),t))};function oe(n,e,t,s,i,r){return N(this,void 0,void 0,function*(){return new Promise((a,o)=>{n(t,ds(e,s,i,r)).then(l=>{if(!l.ok)throw l;return s!=null&&s.noResolveJson?l:l.json()}).then(l=>a(l)).catch(l=>cs(l,o,s))})})}function fe(n,e,t,s){return N(this,void 0,void 0,function*(){return oe(n,"GET",e,t,s)})}function j(n,e,t,s,i){return N(this,void 0,void 0,function*(){return oe(n,"POST",e,s,i,t)})}function us(n,e,t,s,i){return N(this,void 0,void 0,function*(){return oe(n,"PUT",e,s,i,t)})}function fs(n,e,t,s){return N(this,void 0,void 0,function*(){return oe(n,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),s)})}function gt(n,e,t,s,i){return N(this,void 0,void 0,function*(){return oe(n,"DELETE",e,s,i,t)})}var I=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};const ps={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},We={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class gs{constructor(e,t={},s,i){this.url=e,this.headers=t,this.bucketId=s,this.fetch=pt(i)}uploadOrUpdate(e,t,s,i){return I(this,void 0,void 0,function*(){try{let r;const a=Object.assign(Object.assign({},We),i);let o=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(a.upsert)});const l=a.metadata;typeof Blob<"u"&&s instanceof Blob?(r=new FormData,r.append("cacheControl",a.cacheControl),l&&r.append("metadata",this.encodeMetadata(l)),r.append("",s)):typeof FormData<"u"&&s instanceof FormData?(r=s,r.append("cacheControl",a.cacheControl),l&&r.append("metadata",this.encodeMetadata(l))):(r=s,o["cache-control"]=`max-age=${a.cacheControl}`,o["content-type"]=a.contentType,l&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(l)))),i!=null&&i.headers&&(o=Object.assign(Object.assign({},o),i.headers));const c=this._removeEmptyFolders(t),h=this._getFinalPath(c),d=yield this.fetch(`${this.url}/object/${h}`,Object.assign({method:e,body:r,headers:o},a!=null&&a.duplex?{duplex:a.duplex}:{})),u=yield d.json();return d.ok?{data:{path:c,id:u.Id,fullPath:u.Key},error:null}:{data:null,error:u}}catch(r){if(E(r))return{data:null,error:r};throw r}})}upload(e,t,s){return I(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,i){return I(this,void 0,void 0,function*(){const r=this._removeEmptyFolders(e),a=this._getFinalPath(r),o=new URL(this.url+`/object/upload/sign/${a}`);o.searchParams.set("token",t);try{let l;const c=Object.assign({upsert:We.upsert},i),h=Object.assign(Object.assign({},this.headers),{"x-upsert":String(c.upsert)});typeof Blob<"u"&&s instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",s)):typeof FormData<"u"&&s instanceof FormData?(l=s,l.append("cacheControl",c.cacheControl)):(l=s,h["cache-control"]=`max-age=${c.cacheControl}`,h["content-type"]=c.contentType);const d=yield this.fetch(o.toString(),{method:"PUT",body:l,headers:h}),u=yield d.json();return d.ok?{data:{path:r,fullPath:u.Key},error:null}:{data:null,error:u}}catch(l){if(E(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return I(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const i=Object.assign({},this.headers);t!=null&&t.upsert&&(i["x-upsert"]="true");const r=yield j(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:i}),a=new URL(this.url+r.url),o=a.searchParams.get("token");if(!o)throw new Oe("No token returned by API");return{data:{signedUrl:a.toString(),path:e,token:o},error:null}}catch(s){if(E(s))return{data:null,error:s};throw s}})}update(e,t,s){return I(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return I(this,void 0,void 0,function*(){try{return{data:yield j(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(E(i))return{data:null,error:i};throw i}})}copy(e,t,s){return I(this,void 0,void 0,function*(){try{return{data:{path:(yield j(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(E(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,s){return I(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),r=yield j(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},s!=null&&s.transform?{transform:s.transform}:{}),{headers:this.headers});const a=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return r={signedUrl:encodeURI(`${this.url}${r.signedURL}${a}`)},{data:r,error:null}}catch(i){if(E(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,s){return I(this,void 0,void 0,function*(){try{const i=yield j(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),r=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{data:i.map(a=>Object.assign(Object.assign({},a),{signedUrl:a.signedURL?encodeURI(`${this.url}${a.signedURL}${r}`):null})),error:null}}catch(i){if(E(i))return{data:null,error:i};throw i}})}download(e,t){return I(this,void 0,void 0,function*(){const i=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=r?`?${r}`:"";try{const o=this._getFinalPath(e);return{data:yield(yield fe(this.fetch,`${this.url}/${i}/${o}${a}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(o){if(E(o))return{data:null,error:o};throw o}})}info(e){return I(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const s=yield fe(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Se(s),error:null}}catch(s){if(E(s))return{data:null,error:s};throw s}})}exists(e){return I(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield fs(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(E(s)&&s instanceof Te){const i=s.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),i=[],r=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";r!==""&&i.push(r);const o=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});l!==""&&i.push(l);let c=i.join("&");return c!==""&&(c=`?${c}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${s}${c}`)}}}remove(e){return I(this,void 0,void 0,function*(){try{return{data:yield gt(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}})}list(e,t,s){return I(this,void 0,void 0,function*(){try{const i=Object.assign(Object.assign(Object.assign({},ps),t),{prefix:e||""});return{data:yield j(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},s),error:null}}catch(i){if(E(i))return{data:null,error:i};throw i}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const ms="2.7.1",vs={"X-Client-Info":`storage-js/${ms}`};var J=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};class ys{constructor(e,t={},s){this.url=e,this.headers=Object.assign(Object.assign({},vs),t),this.fetch=pt(s)}listBuckets(){return J(this,void 0,void 0,function*(){try{return{data:yield fe(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(E(e))return{data:null,error:e};throw e}})}getBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield fe(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return J(this,void 0,void 0,function*(){try{return{data:yield j(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(E(s))return{data:null,error:s};throw s}})}updateBucket(e,t){return J(this,void 0,void 0,function*(){try{return{data:yield us(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(E(s))return{data:null,error:s};throw s}})}emptyBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield j(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}})}deleteBucket(e){return J(this,void 0,void 0,function*(){try{return{data:yield gt(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}})}}class ws extends ys{constructor(e,t={},s){super(e,t,s)}from(e){return new gs(this.url,this.headers,e,this.fetch)}}const _s="2.49.4";let se="";typeof Deno<"u"?se="deno":typeof document<"u"?se="web":typeof navigator<"u"&&navigator.product==="ReactNative"?se="react-native":se="node";const bs={"X-Client-Info":`supabase-js-${se}/${_s}`},ks={headers:bs},Es={schema:"public"},Ts={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Ss={};var Is=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};const Ps=n=>{let e;return n?e=n:typeof fetch>"u"?e=rt:e=fetch,(...t)=>e(...t)},Cs=()=>typeof Headers>"u"?nt:Headers,xs=(n,e,t)=>{const s=Ps(t),i=Cs();return(r,a)=>Is(void 0,void 0,void 0,function*(){var o;const l=(o=yield e())!==null&&o!==void 0?o:n;let c=new i(a==null?void 0:a.headers);return c.has("apikey")||c.set("apikey",n),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),s(r,Object.assign(Object.assign({},a),{headers:c}))})};var As=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};function Ls(n){return n.replace(/\/$/,"")}function Os(n,e){const{db:t,auth:s,realtime:i,global:r}=n,{db:a,auth:o,realtime:l,global:c}=e,h={db:Object.assign(Object.assign({},a),t),auth:Object.assign(Object.assign({},o),s),realtime:Object.assign(Object.assign({},l),i),global:Object.assign(Object.assign({},c),r),accessToken:()=>As(this,void 0,void 0,function*(){return""})};return n.accessToken?h.accessToken=n.accessToken:delete h.accessToken,h}const mt="2.69.1",G=30*1e3,Ie=3,ve=Ie*G,$s="http://localhost:9999",js="supabase.auth.token",Rs={"X-Client-Info":`gotrue-js/${mt}`},Pe="X-Supabase-Api-Version",vt={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Us=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Ds=6e5;class $e extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function m(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class Bs extends $e{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}function Ms(n){return m(n)&&n.name==="AuthApiError"}class yt extends $e{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class U extends $e{constructor(e,t,s,i){super(e,s,i),this.name=t,this.status=s}}class O extends U{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Ns(n){return m(n)&&n.name==="AuthSessionMissingError"}class ye extends U{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class he extends U{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ce extends U{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function qs(n){return m(n)&&n.name==="AuthImplicitGrantRedirectError"}class Ge extends U{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Ce extends U{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function we(n){return m(n)&&n.name==="AuthRetryableFetchError"}class Ye extends U{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class re extends U{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Xe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Qe=` 	
\r=`.split(""),Vs=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<Qe.length;e+=1)n[Qe[e].charCodeAt(0)]=-2;for(let e=0;e<Xe.length;e+=1)n[Xe[e].charCodeAt(0)]=e;return n})();function wt(n,e,t){const s=Vs[n];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function Ze(n){const e=[],t=a=>{e.push(String.fromCodePoint(a))},s={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},r=a=>{zs(a,s,t)};for(let a=0;a<n.length;a+=1)wt(n.charCodeAt(a),i,r);return e.join("")}function Fs(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function Hs(n,e){for(let t=0;t<n.length;t+=1){let s=n.charCodeAt(t);if(s>55295&&s<=56319){const i=(s-55296)*1024&65535;s=(n.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}Fs(s,e)}}function zs(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let s=1;s<6;s+=1)if((n>>7-s&1)===0){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Js(n){const e=[],t={queue:0,queuedBits:0},s=i=>{e.push(i)};for(let i=0;i<n.length;i+=1)wt(n.charCodeAt(i),t,s);return new Uint8Array(e)}function Ks(n){const e=[];return Hs(n,t=>e.push(t)),new Uint8Array(e)}function Ws(n){return Math.round(Date.now()/1e3)+n}function Gs(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}const A=()=>typeof window<"u"&&typeof document<"u",D={tested:!1,writable:!1},ne=()=>{if(!A())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(D.tested)return D.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),D.tested=!0,D.writable=!0}catch{D.tested=!0,D.writable=!1}return D.writable};function Ys(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,r)=>{e[r]=i})}catch{}return t.searchParams.forEach((s,i)=>{e[i]=s}),e}const _t=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>X(async()=>{const{default:s}=await Promise.resolve().then(()=>Z);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)},Xs=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",bt=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},de=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},ue=async(n,e)=>{await n.removeItem(e)};class pe{constructor(){this.promise=new pe.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}pe.promiseConstructor=Promise;function _e(n){const e=n.split(".");if(e.length!==3)throw new re("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!Us.test(e[s]))throw new re("JWT not in base64url format");return{header:JSON.parse(Ze(e[0])),payload:JSON.parse(Ze(e[1])),signature:Js(e[2]),raw:{header:e[0],payload:e[1]}}}async function Qs(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function Zs(n,e){return new Promise((s,i)=>{(async()=>{for(let r=0;r<1/0;r++)try{const a=await n(r);if(!e(r,null,a)){s(a);return}}catch(a){if(!e(r,a)){i(a);return}}})()})}function ei(n){return("0"+n.toString(16)).substr(-2)}function ti(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=t.length;let i="";for(let r=0;r<56;r++)i+=t.charAt(Math.floor(Math.random()*s));return i}return crypto.getRandomValues(e),Array.from(e,ei).join("")}async function si(n){const t=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(s);return Array.from(i).map(r=>String.fromCharCode(r)).join("")}async function ii(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await si(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function K(n,e,t=!1){const s=ti();let i=s;t&&(i+="/PASSWORD_RECOVERY"),await bt(n,`${e}-code-verifier`,i);const r=await ii(s);return[r,s===r?"plain":"s256"]}const ri=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function ni(n){const e=n.headers.get(Pe);if(!e||!e.match(ri))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function ai(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function oi(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}var li=function(n,e){var t={};for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,s=Object.getOwnPropertySymbols(n);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(n,s[i])&&(t[s[i]]=n[s[i]]);return t};const B=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),hi=[502,503,504];async function et(n){var e;if(!Xs(n))throw new Ce(B(n),0);if(hi.includes(n.status))throw new Ce(B(n),n.status);let t;try{t=await n.json()}catch(r){throw new yt(B(r),r)}let s;const i=ni(n);if(i&&i.getTime()>=vt["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?s=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(s=t.error_code),s){if(s==="weak_password")throw new Ye(B(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new O}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((r,a)=>r&&typeof a=="string",!0))throw new Ye(B(t),n.status,t.weak_password.reasons);throw new Bs(B(t),n.status||500,s)}const ci=(n,e,t,s)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(s),Object.assign(Object.assign({},i),t))};async function v(n,e,t,s){var i;const r=Object.assign({},s==null?void 0:s.headers);r[Pe]||(r[Pe]=vt["2024-01-01"].name),s!=null&&s.jwt&&(r.Authorization=`Bearer ${s.jwt}`);const a=(i=s==null?void 0:s.query)!==null&&i!==void 0?i:{};s!=null&&s.redirectTo&&(a.redirect_to=s.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",l=await di(n,e,t+o,{headers:r,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(l):{data:Object.assign({},l),error:null}}async function di(n,e,t,s,i,r){const a=ci(e,s,i,r);let o;try{o=await n(t,Object.assign({},a))}catch(l){throw console.error(l),new Ce(B(l),0)}if(o.ok||await et(o),s!=null&&s.noResolveJson)return o;try{return await o.json()}catch(l){await et(l)}}function $(n){var e;let t=null;gi(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=Ws(n.expires_in)));const s=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:s},error:null}}function tt(n){const e=$(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,s)=>t&&typeof s=="string",!0)&&(e.data.weak_password=n.weak_password),e}function R(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function ui(n){return{data:n,error:null}}function fi(n){const{action_link:e,email_otp:t,hashed_token:s,redirect_to:i,verification_type:r}=n,a=li(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:t,hashed_token:s,redirect_to:i,verification_type:r},l=Object.assign({},a);return{data:{properties:o,user:l},error:null}}function pi(n){return n}function gi(n){return n.access_token&&n.refresh_token&&n.expires_in}var mi=function(n,e){var t={};for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,s=Object.getOwnPropertySymbols(n);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(n,s[i])&&(t[s[i]]=n[s[i]]);return t};class vi{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=_t(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await v(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(m(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,t={}){try{return await v(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:R})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:t}=e,s=mi(e,["options"]),i=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(i.new_email=s==null?void 0:s.newEmail,delete i.newEmail),await v(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:fi,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(m(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await v(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:R})}catch(t){if(m(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,s,i,r,a,o,l;try{const c={nextPage:null,lastPage:0,total:0},h=await v(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(r=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&r!==void 0?r:""},xform:pi});if(h.error)throw h.error;const d=await h.json(),u=(a=h.headers.get("x-total-count"))!==null&&a!==void 0?a:0,f=(l=(o=h.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(p=>{const y=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(p.split(";")[1].split("=")[1]);c[`${g}Page`]=y}),c.total=parseInt(u)),{data:Object.assign(Object.assign({},d),c),error:null}}catch(c){if(m(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){try{return await v(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:R})}catch(t){if(m(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await v(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:R})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,t=!1){try{return await v(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:R})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){try{const{data:t,error:s}=await v(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:s}}catch(t){if(m(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await v(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(m(t))return{data:null,error:t};throw t}}}const yi={getItem:n=>ne()?globalThis.localStorage.getItem(n):null,setItem:(n,e)=>{ne()&&globalThis.localStorage.setItem(n,e)},removeItem:n=>{ne()&&globalThis.localStorage.removeItem(n)}};function st(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}function wi(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const W={debug:!!(globalThis&&ne()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class kt extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class _i extends kt{}async function bi(n,e,t){W.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),W.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async i=>{if(i){W.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,i.name);try{return await t()}finally{W.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,i.name)}}else{if(e===0)throw W.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new _i(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(W.debug)try{const r=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(r,null,"  "))}catch(r){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",r)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}wi();const ki={url:$s,storageKey:js,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Rs,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function it(n,e,t){return await t()}class ae{constructor(e){var t,s;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=ae.nextInstanceID,ae.nextInstanceID+=1,this.instanceID>0&&A()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const i=Object.assign(Object.assign({},ki),e);if(this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.persistSession=i.persistSession,this.storageKey=i.storageKey,this.autoRefreshToken=i.autoRefreshToken,this.admin=new vi({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=_t(i.fetch),this.lock=i.lock||it,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,i.lock?this.lock=i.lock:A()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=bi:this.lock=it,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?i.storage?this.storage=i.storage:ne()?this.storage=yi:(this.memoryStorage={},this.storage=st(this.memoryStorage)):(this.memoryStorage={},this.storage=st(this.memoryStorage)),A()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(r){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",r)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async r=>{this._debug("received broadcast notification from other tab or client",r),await this._notifyAllSubscribers(r.data.event,r.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${mt}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=Ys(window.location.href);let s="none";if(this._isImplicitGrantCallback(t)?s="implicit":await this._isPKCECallback(t)&&(s="pkce"),A()&&this.detectSessionInUrl&&s!=="none"){const{data:i,error:r}=await this._getSessionFromURL(t,s);if(r){if(this._debug("#_initialize()","error detecting session from URL",r),qs(r)){const l=(e=r.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:r}}return await this._removeSession(),{error:r}}const{session:a,redirectType:o}=i;return this._debug("#_initialize()","detected session in URL",a,"redirect type",o),await this._saveSession(a),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",a):await this._notifyAllSubscribers("SIGNED_IN",a)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return m(t)?{error:t}:{error:new yt("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,s,i;try{const r=await v(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:$}),{data:a,error:o}=r;if(o||!a)return{data:{user:null,session:null},error:o};const l=a.session,c=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(r){if(m(r))return{data:{user:null,session:null},error:r};throw r}}async signUp(e){var t,s,i;try{let r;if("email"in e){const{email:h,password:d,options:u}=e;let f=null,p=null;this.flowType==="pkce"&&([f,p]=await K(this.storage,this.storageKey)),r=await v(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:u==null?void 0:u.emailRedirectTo,body:{email:h,password:d,data:(t=u==null?void 0:u.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken},code_challenge:f,code_challenge_method:p},xform:$})}else if("phone"in e){const{phone:h,password:d,options:u}=e;r=await v(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:h,password:d,data:(s=u==null?void 0:u.data)!==null&&s!==void 0?s:{},channel:(i=u==null?void 0:u.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:$})}else throw new he("You must provide either an email or phone number and a password");const{data:a,error:o}=r;if(o||!a)return{data:{user:null,session:null},error:o};const l=a.session,c=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(r){if(m(r))return{data:{user:null,session:null},error:r};throw r}}async signInWithPassword(e){try{let t;if("email"in e){const{email:r,password:a,options:o}=e;t=await v(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:r,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:tt})}else if("phone"in e){const{phone:r,password:a,options:o}=e;t=await v(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:r,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:tt})}else throw new he("You must provide either an email or phone number and a password");const{data:s,error:i}=t;return i?{data:{user:null,session:null},error:i}:!s||!s.session||!s.user?{data:{user:null,session:null},error:new ye}:(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:i})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,s,i,r;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(r=e.options)===null||r===void 0?void 0:r.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await de(this.storage,`${this.storageKey}-code-verifier`),[s,i]=(t??"").split("/");try{const{data:r,error:a}=await v(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:$});if(await ue(this.storage,`${this.storageKey}-code-verifier`),a)throw a;return!r||!r.session||!r.user?{data:{user:null,session:null,redirectType:null},error:new ye}:(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign(Object.assign({},r),{redirectType:i??null}),error:a})}catch(r){if(m(r))return{data:{user:null,session:null,redirectType:null},error:r};throw r}}async signInWithIdToken(e){try{const{options:t,provider:s,token:i,access_token:r,nonce:a}=e,o=await v(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:i,access_token:r,nonce:a,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:$}),{data:l,error:c}=o;return c?{data:{user:null,session:null},error:c}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new ye}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:c})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,s,i,r,a;try{if("email"in e){const{email:o,options:l}=e;let c=null,h=null;this.flowType==="pkce"&&([c,h]=await K(this.storage,this.storageKey));const{error:d}=await v(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(t=l==null?void 0:l.data)!==null&&t!==void 0?t:{},create_user:(s=l==null?void 0:l.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:h},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:d}}if("phone"in e){const{phone:o,options:l}=e,{data:c,error:h}=await v(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(i=l==null?void 0:l.data)!==null&&i!==void 0?i:{},create_user:(r=l==null?void 0:l.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(a=l==null?void 0:l.channel)!==null&&a!==void 0?a:"sms"}});return{data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:h}}throw new he("You must provide either an email or phone number.")}catch(o){if(m(o))return{data:{user:null,session:null},error:o};throw o}}async verifyOtp(e){var t,s;try{let i,r;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,r=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:a,error:o}=await v(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:r}}),redirectTo:i,xform:$});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const l=a.session,c=a.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(i){if(m(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithSSO(e){var t,s,i;try{let r=null,a=null;return this.flowType==="pkce"&&([r,a]=await K(this.storage,this.storageKey)),await v(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&s!==void 0?s:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:r,code_challenge_method:a}),headers:this.headers,xform:ui})}catch(r){if(m(r))return{data:null,error:r};throw r}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new O;const{error:i}=await v(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:i}})}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:i,options:r}=e,{error:a}=await v(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:i,gotrue_meta_security:{captcha_token:r==null?void 0:r.captchaToken}},redirectTo:r==null?void 0:r.emailRedirectTo});return{data:{user:null,session:null},error:a}}else if("phone"in e){const{phone:s,type:i,options:r}=e,{data:a,error:o}=await v(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:i,gotrue_meta_security:{captcha_token:r==null?void 0:r.captchaToken}}});return{data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o}}throw new he("You must provide either an email or phone number and a type")}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await s,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=t();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await de(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<ve:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.storage.isServer){let a=this.suppressGetSessionWarning;e=new Proxy(e,{get:(l,c,h)=>(!a&&c==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),a=!0,this.suppressGetSessionWarning=!0),Reflect.get(l,c,h))})}return{data:{session:e},error:null}}const{session:i,error:r}=await this._callRefreshToken(e.refresh_token);return r?{data:{session:null},error:r}:{data:{session:i},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await v(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:R}):await this._useSession(async t=>{var s,i,r;const{data:a,error:o}=t;if(o)throw o;return!(!((s=a.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new O}:await v(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(r=(i=a.session)===null||i===void 0?void 0:i.access_token)!==null&&r!==void 0?r:void 0,xform:R})})}catch(t){if(m(t))return Ns(t)&&(await this._removeSession(),await ue(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async s=>{const{data:i,error:r}=s;if(r)throw r;if(!i.session)throw new O;const a=i.session;let o=null,l=null;this.flowType==="pkce"&&e.email!=null&&([o,l]=await K(this.storage,this.storageKey));const{data:c,error:h}=await v(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:l}),jwt:a.access_token,xform:R});if(h)throw h;return a.user=c.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),{data:{user:a.user},error:null}})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new O;const t=Date.now()/1e3;let s=t,i=!0,r=null;const{payload:a}=_e(e.access_token);if(a.exp&&(s=a.exp,i=s<=t),i){const{session:o,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!o)return{data:{user:null,session:null},error:null};r=o}else{const{data:o,error:l}=await this._getUser(e.access_token);if(l)throw l;r={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(r),await this._notifyAllSubscribers("SIGNED_IN",r)}return{data:{user:r.user,session:r},error:null}}catch(t){if(m(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var s;if(!e){const{data:a,error:o}=t;if(o)throw o;e=(s=a.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new O;const{session:i,error:r}=await this._callRefreshToken(e.refresh_token);return r?{data:{user:null,session:null},error:r}:i?{data:{user:i.user,session:i},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!A())throw new ce("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ce(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Ge("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new ce("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ge("No code detected.");const{data:P,error:_}=await this._exchangeCodeForSession(e.code);if(_)throw _;const T=new URL(window.location.href);return T.searchParams.delete("code"),window.history.replaceState(window.history.state,"",T.toString()),{data:{session:P.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:i,access_token:r,refresh_token:a,expires_in:o,expires_at:l,token_type:c}=e;if(!r||!o||!a||!c)throw new ce("No session defined in URL");const h=Math.round(Date.now()/1e3),d=parseInt(o);let u=h+d;l&&(u=parseInt(l));const f=u-h;f*1e3<=G&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${d}s`);const p=u-d;h-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,u,h):h-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,u,h);const{data:y,error:g}=await this._getUser(r);if(g)throw g;const b={provider_token:s,provider_refresh_token:i,access_token:r,expires_in:d,expires_at:u,refresh_token:a,token_type:c,user:y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:b,redirectType:e.type},error:null}}catch(s){if(m(s))return{data:{session:null,redirectType:null},error:s};throw s}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await de(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var s;const{data:i,error:r}=t;if(r)return{error:r};const a=(s=i.session)===null||s===void 0?void 0:s.access_token;if(a){const{error:o}=await this.admin.signOut(a,e);if(o&&!(Ms(o)&&(o.status===404||o.status===401||o.status===403)))return{error:o}}return e!=="others"&&(await this._removeSession(),await ue(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=Gs(),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,i;try{const{data:{session:r},error:a}=t;if(a)throw a;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",r)),this._debug("INITIAL_SESSION","callback id",e,"session",r)}catch(r){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",r),console.error(r)}})}async resetPasswordForEmail(e,t={}){let s=null,i=null;this.flowType==="pkce"&&([s,i]=await K(this.storage,this.storageKey,!0));try{return await v(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(r){if(m(r))return{data:null,error:r};throw r}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(m(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:s,error:i}=await this._useSession(async r=>{var a,o,l,c,h;const{data:d,error:u}=r;if(u)throw u;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(a=e.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await v(this.fetch,"GET",f,{headers:this.headers,jwt:(h=(c=d.session)===null||c===void 0?void 0:c.access_token)!==null&&h!==void 0?h:void 0})});if(i)throw i;return A()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),{data:{provider:e.provider,url:s==null?void 0:s.url},error:null}}catch(s){if(m(s))return{data:{provider:e.provider,url:null},error:s};throw s}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var s,i;const{data:r,error:a}=t;if(a)throw a;return await v(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(s=r.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const s=Date.now();return await Zs(async i=>(i>0&&await Qs(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await v(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:$})),(i,r)=>{const a=200*Math.pow(2,i);return r&&we(r)&&Date.now()+a-s<G})}catch(s){if(this._debug(t,"error",s),m(s))return{data:{session:null,user:null},error:s};throw s}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),A()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const s=await de(this.storage,this.storageKey);if(this._debug(t,"session from storage",s),!this._isValidSession(s)){this._debug(t,"session is not valid"),s!==null&&await this._removeSession();return}const i=((e=s.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<ve;if(this._debug(t,`session has${i?"":" not"} expired with margin of ${ve}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:r}=await this._callRefreshToken(s.refresh_token);r&&(console.error(r),we(r)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",r),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(t,"error",s),console.error(s);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new O;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new pe;const{data:r,error:a}=await this._refreshAccessToken(e);if(a)throw a;if(!r.session)throw new O;await this._saveSession(r.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",r.session);const o={session:r.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(r){if(this._debug(i,"error",r),m(r)){const a={session:null,error:r};return we(r)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(a),a}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(r),r}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,s=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const r=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,t)}catch(l){r.push(l)}});if(await Promise.all(a),r.length>0){for(let o=0;o<r.length;o+=1)console.error(r[o]);throw r[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await bt(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await ue(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&A()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),G);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((s.expires_at*1e3-e)/G);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${G}ms, refresh threshold is ${Ie} ticks`),i<=Ie&&await this._callRefreshToken(s.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof kt)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!A()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const i=[`provider=${encodeURIComponent(t)}`];if(s!=null&&s.redirectTo&&i.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&i.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[r,a]=await K(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(r)}`,code_challenge_method:`${encodeURIComponent(a)}`});i.push(o.toString())}if(s!=null&&s.queryParams){const r=new URLSearchParams(s.queryParams);i.push(r.toString())}return s!=null&&s.skipBrowserRedirect&&i.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var s;const{data:i,error:r}=t;return r?{data:null,error:r}:await v(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var s,i;const{data:r,error:a}=t;if(a)return{data:null,error:a};const o=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:l,error:c}=await v(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(s=r==null?void 0:r.session)===null||s===void 0?void 0:s.access_token});return c?{data:null,error:c}:(e.factorType==="totp"&&(!((i=l==null?void 0:l.totp)===null||i===void 0)&&i.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),{data:l,error:null})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:i,error:r}=t;if(r)return{data:null,error:r};const{data:a,error:o}=await v(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});return o?{data:null,error:o}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),{data:a,error:o})})}catch(t){if(m(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:i,error:r}=t;return r?{data:null,error:r}:await v(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(m(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const s=(e==null?void 0:e.factors)||[],i=s.filter(a=>a.factor_type==="totp"&&a.status==="verified"),r=s.filter(a=>a.factor_type==="phone"&&a.status==="verified");return{data:{all:s,totp:i,phone:r},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,s;const{data:{session:i},error:r}=e;if(r)return{data:null,error:r};if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:a}=_e(i.access_token);let o=null;a.aal&&(o=a.aal);let l=o;((s=(t=i.user.factors)===null||t===void 0?void 0:t.filter(d=>d.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(l="aal2");const h=a.amr||[];return{data:{currentLevel:o,nextLevel:l,currentAuthenticationMethods:h},error:null}}))}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(a=>a.kid===e);if(s||(s=this.jwks.keys.find(a=>a.kid===e),s&&this.jwks_cached_at+Ds>Date.now()))return s;const{data:i,error:r}=await v(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(r)throw r;if(!i.keys||i.keys.length===0)throw new re("JWKS is empty");if(this.jwks=i,this.jwks_cached_at=Date.now(),s=i.keys.find(a=>a.kid===e),!s)throw new re("No matching signing key found in JWKS");return s}async getClaims(e,t={keys:[]}){try{let s=e;if(!s){const{data:f,error:p}=await this.getSession();if(p||!f.session)return{data:null,error:p};s=f.session.access_token}const{header:i,payload:r,signature:a,raw:{header:o,payload:l}}=_e(s);if(ai(r.exp),!i.kid||i.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:r,header:i,signature:a},error:null}}const c=oi(i.alg),h=await this.fetchJwk(i.kid,t),d=await crypto.subtle.importKey("jwk",h,c,!0,["verify"]);if(!await crypto.subtle.verify(c,d,a,Ks(`${o}.${l}`)))throw new re("Invalid JWT signature");return{data:{claims:r,header:i,signature:a},error:null}}catch(s){if(m(s))return{data:null,error:s};throw s}}}ae.nextInstanceID=0;const Ei=ae;class Ti extends Ei{constructor(e){super(e)}}var Si=function(n,e,t,s){function i(r){return r instanceof t?r:new t(function(a){a(r)})}return new(t||(t=Promise))(function(r,a){function o(h){try{c(s.next(h))}catch(d){a(d)}}function l(h){try{c(s.throw(h))}catch(d){a(d)}}function c(h){h.done?r(h.value):i(h.value).then(o,l)}c((s=s.apply(n,e||[])).next())})};class Ii{constructor(e,t,s){var i,r,a;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const o=Ls(e);this.realtimeUrl=`${o}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${o}/auth/v1`,this.storageUrl=`${o}/storage/v1`,this.functionsUrl=`${o}/functions/v1`;const l=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,c={db:Es,realtime:Ss,auth:Object.assign(Object.assign({},Ts),{storageKey:l}),global:ks},h=Os(s??{},c);this.storageKey=(i=h.auth.storageKey)!==null&&i!==void 0?i:"",this.headers=(r=h.global.headers)!==null&&r!==void 0?r:{},h.accessToken?(this.accessToken=h.accessToken,this.auth=new Proxy({},{get:(d,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((a=h.auth)!==null&&a!==void 0?a:{},this.headers,h.global.fetch),this.fetch=xs(t,this._getAccessToken.bind(this),h.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},h.realtime)),this.rest=new Ht(`${o}/rest/v1`,{headers:this.headers,schema:h.db.schema,fetch:this.fetch}),h.accessToken||this._listenForAuthEvents()}get functions(){return new At(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new ws(this.storageUrl,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return Si(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:s}=yield this.auth.getSession();return(t=(e=s.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,storageKey:r,flowType:a,lock:o,debug:l},c,h){const d={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Ti({url:this.authUrl,headers:Object.assign(Object.assign({},d),c),storageKey:r,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,flowType:a,lock:o,debug:l,fetch:h,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new ns(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,s)=>{this._handleTokenChanged(t,"CLIENT",s==null?void 0:s.access_token)})}_handleTokenChanged(e,t,s){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==s?this.changedAccessToken=s:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const Pi=(n,e,t)=>new Ii(n,e,t);class Ci{constructor(){var e;this.supabase=Pi("https://seckthcbnslsropswpik.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlY2t0aGNibnNsc3JvcHN3cGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxNzU3ODMsImV4cCI6MjA1ODc1MTc4M30.JoI03vFuRd-7sApD4dZ-zeBfUQlZrzRg7jtz0HgnJyI"),this.state={currentVideo:null,playlist:[],preloaded:new Map,currentIndex:0,userId:null,uploadedFile:null,uploadedFileUrl:null,channels:JSON.parse(localStorage.getItem("channels"))||{},isSubmenuOpen:!1,isProgressBarActivated:!1,hasViewed:!1,isSwiping:!1,isDragging:!1,isHolding:!1,lastTime:0,touchTimeout:null,startX:0,startY:0,endX:0,endY:0},this.tg=(e=window.Telegram)==null?void 0:e.WebApp,this.MAX_PRELOAD_SIZE=3,this.MAX_PLAYLIST_SIZE=10,this.tg?(this.tg.ready(),this.tg.expand(),console.log("Telegram Web App :",this.tg.initDataUnsafe)):console.warn("Telegram Web App SDK  .    .")}async init(){var e,t;console.log(" ,  10"),(t=(e=this.tg)==null?void 0:e.initDataUnsafe)!=null&&t.user?(this.state.userId=String(this.tg.initDataUnsafe.user.id),console.log("Telegram , userId:",this.state.userId)):(this.state.userId="testUser_"+Date.now(),console.log(" userId:",this.state.userId)),console.log(" :",this.state.channels),this.bindElements(),this.bindEvents(),await this.loadInitialVideos(),this.showPlayer()}bindElements(){this.authScreen=document.getElementById("authScreen"),this.playerContainer=document.getElementById("playerContainer"),this.authBtn=document.getElementById("authBtn"),this.registerChannelBtn=document.getElementById("registerChannelBtn"),this.userAvatar=document.getElementById("userAvatar"),this.video=document.getElementById("videoPlayer"),this.videoSource=document.getElementById("videoSource"),this.viewCountSpan=document.getElementById("viewCount"),this.likeCountEl=document.getElementById("likeCount"),this.dislikeCountEl=document.getElementById("dislikeCount"),this.commentCountEl=document.getElementById("commentCount"),this.shareCountEl=document.getElementById("shareCount"),this.ratingEl=document.getElementById("rating"),this.reactionBar=document.getElementById("reactionBar"),this.reactionButtons=document.querySelectorAll(".reaction-btn"),this.swipeArea=document.getElementById("swipeArea"),this.reactionAnimation=document.getElementById("reactionAnimation"),this.progressBar=document.getElementById("progressBar"),this.progressRange=document.getElementById("progressRange"),this.commentsWindow=document.getElementById("commentsWindow"),this.commentsList=document.getElementById("commentsList"),this.commentInput=document.getElementById("commentInput"),this.sendCommentBtn=document.getElementById("sendComment"),this.themeToggle=document.querySelector(".theme-toggle"),this.toggleReactionBar=document.querySelector(".toggle-reaction-bar"),this.plusBtn=document.querySelector(".plus-btn"),this.uploadBtn=document.querySelector(".upload-btn"),this.submenuUpload=document.getElementById("uploadVideo"),this.submenuChat=document.getElementById("chatAuthor"),this.uploadModal=document.getElementById("uploadModal"),this.uploadProgress=document.getElementById("progressBarInner"),this.uploadPreview=document.getElementById("uploadPreview"),this.publishBtn=document.getElementById("publishBtn"),this.cancelBtn=document.getElementById("cancelBtn"),this.chatModal=document.getElementById("chatModal"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.sendChatMessage=document.getElementById("sendChatMessage"),this.closeChat=document.getElementById("closeChat"),this.shareModal=document.getElementById("shareModal"),this.shareTelegram=document.getElementById("shareTelegram"),this.copyLink=document.getElementById("copyLink"),this.closeShare=document.getElementById("closeShare"),this.videoUpload=document.createElement("input"),this.videoUpload.type="file",this.videoUpload.accept="video/mp4,video/quicktime,video/webm",this.videoUpload.style.display="none",document.body.appendChild(this.videoUpload)}bindEvents(){const e=(s,i,r)=>{s?(s.addEventListener("click",i),console.log(`${r} `)):console.warn(`${r}  `)};e(this.authBtn,()=>this.handleAuth(),"#authBtn"),e(this.registerChannelBtn,()=>this.registerChannel(),"#registerChannelBtn"),this.reactionButtons.forEach(s=>s.addEventListener("click",i=>this.handleReaction(s.dataset.type,i))),e(this.plusBtn,s=>this.toggleSubmenu(s),".plus-btn"),e(this.uploadBtn,s=>this.downloadCurrentVideo(s),".upload-btn"),e(this.toggleReactionBar,s=>this.toggleReactionBarVisibility(s),".toggle-reaction-bar"),this.video&&(this.video.addEventListener("loadedmetadata",()=>this.handleLoadedMetadata(),{once:!0}),this.video.addEventListener("play",()=>this.handlePlay()),this.video.addEventListener("pause",()=>this.handlePause()),this.video.addEventListener("ended",()=>this.handleEnded()),this.video.addEventListener("timeupdate",()=>this.handleTimeUpdate())),e(this.progressRange,s=>this.handleProgressInput(s),"#progressRange"),this.setupSwipeAndMouseEvents(),e(this.sendCommentBtn,()=>this.addComment(),"#sendComment"),this.commentInput&&this.commentInput.addEventListener("keypress",s=>s.key==="Enter"&&this.addComment()),e(this.submenuUpload,s=>this.handleSubmenuUpload(s),"#uploadVideo"),this.videoUpload&&this.videoUpload.addEventListener("change",s=>this.handleVideoUpload(s)),e(this.publishBtn,()=>this.publishVideo(),"#publishBtn"),e(this.cancelBtn,()=>this.cancelUpload(),"#cancelBtn"),e(this.submenuChat,s=>this.handleSubmenuChat(s),"#chatAuthor"),e(this.sendChatMessage,()=>this.sendChat(),"#sendChatMessage"),this.chatInput&&this.chatInput.addEventListener("keypress",s=>s.key==="Enter"&&this.sendChat()),e(this.closeChat,()=>this.chatModal.classList.remove("visible"),"#closeChat"),e(this.shareTelegram,()=>this.shareViaTelegram(),"#shareTelegram"),e(this.copyLink,()=>this.copyVideoLink(),"#copyLink"),e(this.closeShare,()=>this.shareModal.classList.remove("visible"),"#closeShare"),e(this.themeToggle,()=>this.toggleTheme(),".theme-toggle");const t=document.querySelector(".drag-handle");t&&(t.addEventListener("mousedown",s=>this.startDragging(s)),t.addEventListener("touchstart",s=>this.startDragging(s),{passive:!1})),e(document.querySelector(".fullscreen-btn"),s=>this.toggleFullscreen(s),".fullscreen-btn"),document.addEventListener("click",s=>this.hideManagementListOnClickOutside(s)),this.bindUserAvatar()}handleAuth(){var e,t;(t=(e=this.tg)==null?void 0:e.initDataUnsafe)!=null&&t.user?(this.state.userId=String(this.tg.initDataUnsafe.user.id),this.showNotification(" : "+this.state.userId)):(this.state.userId="browserTestUser_"+Date.now(),this.showNotification(" : "+this.state.userId)),this.showPlayer()}showPlayer(){this.authScreen&&this.playerContainer?(this.authScreen.style.display="none",this.playerContainer.style.display="flex",this.initializePlayer()):console.error(": authScreen  playerContainer  ")}bindUserAvatar(){if(!this.userAvatar){console.error(" #userAvatar  !");return}this.userAvatar.addEventListener("click",i=>{if(i.stopPropagation(),!this.state.isHolding){const r=this.state.channels[this.state.userId];if(r!=null&&r.link)try{this.tg&&this.tg.openTelegramLink?this.tg.openTelegramLink(r.link):window.open(r.link,"_blank")}catch(a){console.error("   :",a),this.showNotification("   !")}else this.showNotification("  .  !"),this.registerChannel()}});const e=2e3,t=i=>{i.preventDefault(),!(this.state.touchTimeout||this.state.isHolding)&&(this.state.isHolding=!0,this.userAvatar.classList.add("holding"),this.state.touchTimeout=setTimeout(()=>{this.showVideoManagementList(),this.state.isHolding=!1,this.userAvatar.classList.remove("holding"),this.state.touchTimeout=null},e))},s=()=>{this.state.touchTimeout&&(clearTimeout(this.state.touchTimeout),this.state.touchTimeout=null),this.state.isHolding=!1,this.userAvatar.classList.remove("holding")};this.userAvatar.addEventListener("mousedown",t),this.userAvatar.addEventListener("mouseup",s),this.userAvatar.addEventListener("mouseleave",s),this.userAvatar.addEventListener("touchstart",t,{passive:!1}),this.userAvatar.addEventListener("touchend",s),this.userAvatar.addEventListener("touchcancel",s),this.userAvatar.addEventListener("touchmove",s,{passive:!1})}async registerChannel(){if(!this.state.userId){this.showNotification(",   Telegram.");return}const e=prompt("    Telegram- (, https://t.me/yourchannel):");if(e&&e.match(/^https:\/\/t\.me\/[a-zA-Z0-9_]+$/))try{const t=await fetch("https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/register-channel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telegram_id:this.state.userId,channel_link:e})});if(!t.ok){const i=await t.text();throw new Error(` : ${t.status} ${i}`)}const s=await t.json();this.state.channels[this.state.userId]={videos:[],link:e},localStorage.setItem("channels",JSON.stringify(this.state.channels)),this.showNotification("  !"),this.showPlayer()}catch(t){console.error("  :",t),this.showNotification(`   : ${t.message}`)}else this.showNotification("    Telegram-.")}initializePlayer(){var e,t,s;this.userAvatar&&((s=(t=(e=this.tg)==null?void 0:e.initDataUnsafe)==null?void 0:t.user)!=null&&s.photo_url)?this.userAvatar.src=this.tg.initDataUnsafe.user.photo_url:this.userAvatar.src="/images/default-avatar.png",this.initializeTheme(),this.initializeTooltips()}async loadInitialVideos(){const e=[{url:"https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4",data:this.createEmptyVideoData("testAuthor123")},{url:"https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_2mb.mp4",data:this.createEmptyVideoData("testAuthor123")},{url:"https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_5mb.mp4",data:this.createEmptyVideoData("testAuthor123")}];try{const t=await fetch("https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/public-videos");if(!t.ok)throw new Error(` : ${t.status}`);const s=await t.json();!s||!Array.isArray(s)||s.length===0?(console.warn("     ,   "),this.state.playlist=e):this.state.playlist=s.map(i=>({url:i.url,data:{views:new Set(i.views||[]),likes:i.likes||0,dislikes:i.dislikes||0,userLikes:new Set(i.user_likes||[]),userDislikes:new Set(i.user_dislikes||[]),comments:i.comments||[],shares:i.shares||0,viewTime:i.view_time||0,replays:i.replays||0,duration:i.duration||0,authorId:i.author_id,lastPosition:i.last_position||0,chatMessages:i.chat_messages||[],description:i.description||""}}))}catch(t){console.error("    :",t),this.showNotification(`     : ${t.message}`),this.state.playlist=e}this.state.playlist.length>0?(this.state.currentIndex=0,this.loadVideo()):(console.error("    !"),this.showNotification("   !"))}createEmptyVideoData(e){return{views:new Set,likes:0,dislikes:0,userLikes:new Set,userDislikes:new Set,comments:[],shares:0,viewTime:0,replays:0,duration:0,authorId:e,lastPosition:0,chatMessages:[],description:""}}handleLoadedMetadata(){var t;if(!this.video)return;this.video.muted=!0,this.video.play().then(()=>{this.video.pause(),this.video.muted=!1}).catch(s=>console.error("Unlock error:",s));const e=(t=this.state.playlist[this.state.currentIndex])==null?void 0:t.data;e&&(e.duration=this.video.duration,this.progressRange.max=this.video.duration,this.progressRange.value=e.lastPosition||0,this.updateVideoCache(this.state.currentIndex),this.updateRating())}handlePlay(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;!this.state.hasViewed&&this.state.userId&&(e.views.add(this.state.userId),this.state.hasViewed=!0,this.updateCounters()),this.state.isProgressBarActivated&&this.progressBar.classList.remove("visible"),this.state.isProgressBarActivated=!1,this.commentsWindow.classList.remove("visible"),this.preloadNextVideo()}handlePause(){var t;if(!this.state.playlist||this.state.playlist.length===0)return;this.state.isProgressBarActivated||(this.state.isProgressBarActivated=!0,this.progressBar.classList.add("visible"));const e=(t=this.state.playlist[this.state.currentIndex])==null?void 0:t.data;e&&(e.lastPosition=this.video.currentTime,this.updateVideoCache(this.state.currentIndex))}handleEnded(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;this.video.currentTime>=this.video.duration*.9&&e.replays++,e.lastPosition=0,this.updateVideoCache(this.state.currentIndex),this.playNextVideo()}handleTimeUpdate(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;e.viewTime+=this.video.currentTime-this.state.lastTime,e.lastPosition=this.video.currentTime,this.state.lastTime=this.video.currentTime,this.progressRange.value=this.video.currentTime,this.updateVideoCache(this.state.currentIndex),this.updateRating()}handleProgressInput(e){var s;if(!this.state.playlist||this.state.playlist.length===0)return;this.video.currentTime=e.target.value;const t=(s=this.state.playlist[this.state.currentIndex])==null?void 0:s.data;t&&(t.lastPosition=this.video.currentTime,this.updateVideoCache(this.state.currentIndex))}setupSwipeAndMouseEvents(){this.swipeArea&&(this.swipeArea.addEventListener("touchstart",e=>this.handleTouchStart(e),{passive:!1}),this.swipeArea.addEventListener("touchmove",this.throttle(e=>this.handleTouchMove(e),16),{passive:!1}),this.swipeArea.addEventListener("touchend",e=>this.handleTouchEnd(e)),this.swipeArea.addEventListener("mousedown",e=>this.handleMouseStart(e)),this.swipeArea.addEventListener("mousemove",this.throttle(e=>this.handleMouseMove(e),16)),this.swipeArea.addEventListener("mouseup",e=>this.handleMouseEnd(e)))}handleTouchStart(e){e.preventDefault(),this.state.startX=e.touches[0].clientX,this.state.startY=e.touches[0].clientY,this.state.isSwiping=!1,!this.state.isHolding&&!this.state.isDragging&&this.toggleVideoPlayback()}handleTouchMove(e){this.state.endX=e.touches[0].clientX,this.state.endY=e.touches[0].clientY;const t=this.state.endX-this.state.startX,s=this.state.endY-this.state.startY,i=10;(Math.abs(t)>i||Math.abs(s)>i)&&(this.state.isSwiping=!0)}handleTouchEnd(e){const t=this.state.endX-this.state.startX,s=this.state.endY-this.state.startY,i=50,r=50,a=10;if(!(Math.abs(t)<a&&Math.abs(s)<a)){if(!this.state.userId){this.showNotification(",   ");return}Math.abs(t)>i&&Math.abs(t)>Math.abs(s)?(t>0?this.playNextVideo():this.playPreviousVideo(),this.state.isProgressBarActivated&&this.progressBar.classList.remove("visible"),this.state.isProgressBarActivated=!1):Math.abs(s)>r&&Math.abs(s)>Math.abs(t)&&(s<0?(this.handleReaction("like"),this.showFloatingReaction("like",this.state.endX,this.state.startY)):s>0&&(this.handleReaction("dislike"),this.showFloatingReaction("dislike",this.state.endX,this.state.startY))),this.state.isSwiping=!1}}handleMouseStart(e){e.preventDefault(),this.state.isDragging=!0,this.state.startX=e.clientX,this.state.startY=e.clientY,this.state.isSwiping=!1,this.state.isHolding||this.toggleVideoPlayback()}handleMouseMove(e){if(!this.state.isDragging)return;this.state.endX=e.clientX,this.state.endY=e.clientY;const t=this.state.endX-this.state.startX,s=this.state.endY-this.state.startY,i=10;(Math.abs(t)>i||Math.abs(s)>i)&&(this.state.isSwiping=!0)}handleMouseEnd(e){if(!this.state.isDragging)return;this.state.isDragging=!1;const t=this.state.endX-this.state.startX,s=this.state.endY-this.state.startY,i=50,r=50,a=10;if(!(Math.abs(t)<a&&Math.abs(s)<a)){if(!this.state.userId){this.showNotification(",   ");return}Math.abs(t)>i&&Math.abs(t)>Math.abs(s)?(t>0?this.playNextVideo():this.playPreviousVideo(),this.state.isProgressBarActivated&&this.progressBar.classList.remove("visible"),this.state.isProgressBarActivated=!1):Math.abs(s)>r&&Math.abs(s)>Math.abs(t)&&(s<0?(this.handleReaction("like"),this.showFloatingReaction("like",this.state.endX,this.state.startY)):s>0&&(this.handleReaction("dislike"),this.showFloatingReaction("dislike",this.state.endX,this.state.startY))),this.state.isSwiping=!1}}showFloatingReaction(e,t,s){const i=document.createElement("div");i.className=`floating-reaction ${e}`,i.textContent=e==="like"?"":"",i.style.left=`${t}px`,i.style.top=`${s}px`,document.body.appendChild(i),setTimeout(()=>i.remove(),1500)}playNextVideo(){!this.state.playlist||this.state.playlist.length===0||(this.recommendNextVideo(),this.loadVideo("left"),this.state.hasViewed=!1)}playPreviousVideo(){!this.state.playlist||this.state.playlist.length===0||(this.state.currentIndex=(this.state.currentIndex-1+this.state.playlist.length)%this.state.playlist.length,this.loadVideo("right"),this.state.hasViewed=!1)}loadVideo(e="left"){if(!this.state.playlist||this.state.playlist.length===0){this.showNotification("   !");return}(this.state.currentIndex<0||this.state.currentIndex>=this.state.playlist.length)&&(this.state.currentIndex=0);const t=e==="left"?"fade-out-left":"fade-out-right";this.video.classList.remove("fade-in"),this.video.classList.add(t),this.video.pause(),setTimeout(()=>{this.videoSource.src=this.state.playlist[this.state.currentIndex].url,this.video.load();const s=setTimeout(()=>{this.video.readyState||(this.showNotification("  !"),this.playNextVideo())},5e3);this.video.addEventListener("canplay",()=>{clearTimeout(s);const i=this.state.playlist[this.state.currentIndex].data.lastPosition;this.video.classList.remove("fade-out-left","fade-out-right"),this.video.classList.add("fade-in"),i>0&&i<this.video.duration?this.showResumePrompt(i):this.video.play().catch(r=>console.log(" :",r))},{once:!0}),this.updateCounters(),this.updateComments(),this.updateRating(),this.updateDescription(),this.preloadNextVideo()},300)}showResumePrompt(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--notification-bg); color: var(--notification-text);
            padding: 20px; border-radius: 10px; z-index: 100; text-align: center;
        `,t.innerHTML=`
            <p>  ${this.formatTime(e)}?</p>
            <button id="resumeYes"></button>
            <button id="resumeNo"></button>
        `,document.body.appendChild(t),document.getElementById("resumeYes").addEventListener("click",()=>{this.video.currentTime=e,this.video.play(),document.body.removeChild(t)}),document.getElementById("resumeNo").addEventListener("click",()=>{this.video.currentTime=0,this.video.play(),document.body.removeChild(t)})}async addComment(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data,t=this.commentInput.value.trim();if(t&&this.state.userId){const s={userId:this.state.userId,text:t,replyTo:this.commentInput.dataset.replyTo||null};e.comments.push(s),this.commentInput.value="",this.commentInput.dataset.replyTo="",this.commentInput.placeholder=" ...",this.updateComments(),this.updateCounters(),await this.updateVideoCache(this.state.currentIndex)}}updateComments(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;this.commentsList.innerHTML="",e.comments.forEach((t,s)=>{var l,c,h,d,u,f,p,y,g,b,P,_;const i=((h=(c=(l=this.tg)==null?void 0:l.initDataUnsafe)==null?void 0:c.user)==null?void 0:h.id)===t.userId&&((f=(u=(d=this.tg)==null?void 0:d.initDataUnsafe)==null?void 0:u.user)!=null&&f.photo_url)?this.tg.initDataUnsafe.user.photo_url:"/images/default-avatar.png",r=((g=(y=(p=this.tg)==null?void 0:p.initDataUnsafe)==null?void 0:y.user)==null?void 0:g.id)===t.userId&&((_=(P=(b=this.tg)==null?void 0:b.initDataUnsafe)==null?void 0:P.user)!=null&&_.username)?`@${this.tg.initDataUnsafe.user.username}`:`User_${t.userId.slice(0,5)}`,a=t.userId===this.state.userId,o=document.createElement("div");o.className="comment",o.innerHTML=`
                <img src="${i}" alt="User Avatar" class="comment-avatar" data-user-id="${t.userId}">
                <div class="comment-content">
                    <span class="comment-username">${r}</span>
                    <div class="comment-text">${this.sanitize(t.text)}${t.replyTo!==null&&e.comments[t.replyTo]?`<blockquote>: ${this.sanitize(e.comments[t.replyTo].text)}</blockquote>`:""}</div>
                </div>
                <button class="reply-btn" data-index="${s}"></button>
                ${a?`<button class="delete-comment-btn" data-index="${s}"></button>`:""}
            `,this.commentsList.appendChild(o),o.querySelector(".reply-btn").addEventListener("click",()=>this.replyToComment(s)),a&&o.querySelector(".delete-comment-btn").addEventListener("click",()=>this.deleteComment(s)),o.querySelector(".comment-avatar").addEventListener("click",()=>this.handleAvatarClick(t.userId))}),this.commentsList.scrollTop=this.commentsList.scrollHeight}sanitize(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}replyToComment(e){this.commentInput.dataset.replyTo=e,this.commentInput.placeholder=` : "${this.state.playlist[this.state.currentIndex].data.comments[e].text.slice(0,20)}..."`,this.commentInput.focus()}async deleteComment(e){!this.state.playlist||this.state.playlist.length===0||confirm("  ?")&&(this.state.playlist[this.state.currentIndex].data.comments.splice(e,1),this.updateComments(),this.updateCounters(),await this.updateVideoCache(this.state.currentIndex),this.showNotification(" "))}handleAvatarClick(e){const t=this.state.channels[e];if(t!=null&&t.link)try{this.tg&&this.tg.openTelegramLink?this.tg.openTelegramLink(t.link):window.open(t.link,"_blank")}catch(s){console.error("   :",s),this.showNotification("   !")}else this.showNotification("  ")}updateDescription(){var s;if(!this.state.playlist||this.state.playlist.length===0)return;let e=document.getElementById("videoDescriptionDisplay");e||(e=document.createElement("div"),e.id="videoDescriptionDisplay",e.style.cssText="margin-top: 10px; color: var(--text-color);",(s=document.querySelector(".video-wrapper"))==null||s.insertAdjacentElement("afterend",e));const t=this.state.playlist[this.state.currentIndex].data.description||" ";e.textContent=t,e.style.display=t!==" "?"block":"none"}updateChat(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;this.chatMessages.innerHTML="",e.chatMessages.forEach(t=>{const s=document.createElement("div");s.className=`message ${t.sender===this.state.userId?"sent":"received"}`,s.textContent=t.text,this.chatMessages.appendChild(s)}),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}async sendChat(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data,t=this.chatInput.value.trim();t&&(e.chatMessages.push({sender:this.state.userId,text:t}),this.chatInput.value="",this.updateChat(),await this.updateVideoCache(this.state.currentIndex),setTimeout(()=>{e.chatMessages.push({sender:e.authorId,text:"  !"}),this.updateChat(),this.updateVideoCache(this.state.currentIndex)},1e3))}handleSubmenuChat(e){e.stopPropagation(),this.chatModal.classList.add("visible"),this.updateChat(),this.toggleSubmenu()}shareViaTelegram(){var i;if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].url,t=this.state.playlist[this.state.currentIndex].data.description||"   !",s=`${t}
${e}`;(i=this.tg)!=null&&i.openTelegramLink?this.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`):navigator.clipboard.writeText(s).then(()=>this.showNotification(" !    Telegram.")).catch(r=>this.showNotification("   ")),this.shareModal.classList.remove("visible"),this.state.playlist[this.state.currentIndex].data.shares++,this.updateCounters(),this.updateVideoCache(this.state.currentIndex)}copyVideoLink(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].url;navigator.clipboard.writeText(e).then(()=>{this.showNotification(" !"),this.shareModal.classList.remove("visible")}).catch(t=>this.showNotification("   "))}async handleVideoUpload(e){if(this.state.uploadedFile=e.target.files[0],!this.state.uploadedFile){this.showNotification("   !");return}const t=100*1024*1024,s=["video/mp4","video/quicktime","video/webm"];if(this.state.uploadedFile.size>t){this.showNotification("  !  100 ."),this.state.uploadedFile=null;return}if(!s.includes(this.state.uploadedFile.type)){this.showNotification(" !  MP4, MOV  WebM."),this.state.uploadedFile=null;return}this.uploadModal.classList.add("visible"),this.uploadProgress.style.width="0%",this.uploadPreview.style.display="none",this.publishBtn.disabled=!0;const i=document.getElementById("videoDescription");i&&(i.value=""),this.uploadPreview.src=URL.createObjectURL(this.state.uploadedFile),this.uploadPreview.style.display="block",this.publishBtn.disabled=!1,this.uploadPreview.onloadedmetadata=()=>{var a;const r=(a=this.state.playlist[this.state.currentIndex])==null?void 0:a.data;r&&(r.duration=this.uploadPreview.duration,this.updateVideoCache(this.state.currentIndex)),this.uploadPreview.onloadedmetadata=null}}async publishVideo(){var i;if(!this.state.uploadedFile){this.showNotification("   !");return}const e=this.state.uploadedFile,t=((i=document.getElementById("videoDescription"))==null?void 0:i.value)||"",s=new FormData;s.append("file",e),s.append("telegram_id",this.state.userId),s.append("description",t);try{const r=await fetch("https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/upload-video",{method:"POST",body:s});if(!r.ok){const l=await r.text();throw new Error(`  : ${r.status} ${l}`)}const{url:a}=await r.json();this.showNotification("  !"),this.uploadModal.classList.remove("visible"),this.state.uploadedFile=null,this.uploadPreview.src&&(URL.revokeObjectURL(this.uploadPreview.src),this.uploadPreview.src="",this.uploadPreview.style.display="none");const o=this.createEmptyVideoData(this.state.userId);o.description=t,this.state.playlist.unshift({url:a,data:o}),this.state.currentIndex=0,this.loadVideo(),this.addVideoToManagementList(a,t)}catch(r){console.error("  :",r),this.showNotification(`: ${r.message}`)}}cancelUpload(){this.state.uploadedFileUrl&&URL.revokeObjectURL(this.state.uploadedFileUrl),this.state.uploadedFileUrl=null,this.state.uploadedFile=null,this.uploadModal.classList.remove("visible"),this.uploadPreview.src="",this.uploadPreview.style.display="none"}addVideoToManagementList(e,t){const s=document.getElementById("videoManagementList")||this.createManagementList(),i=document.createElement("div");i.className="video-item",i.innerHTML=`
            <span>${t||" "}</span>
            <button class="edit-btn" data-url="${e}"></button>
            <button class="delete-btn" data-url="${e}"></button>
        `,s.appendChild(i),i.querySelector(".edit-btn").addEventListener("click",()=>this.editVideo(e)),i.querySelector(".delete-btn").addEventListener("click",()=>this.deleteVideo(e))}createManagementList(){const e=document.createElement("div");e.id="videoManagementList",e.style.cssText="position: absolute; bottom: 6vh; left: 2vw; background: rgba(0, 0, 0, 0.8); padding: 10px; border-radius: 10px; z-index: 100; display: none;";const t=document.createElement("button");return t.className="close-list-btn",t.innerHTML='<i class="fas fa-times"></i>',t.addEventListener("click",()=>e.classList.remove("visible")),e.appendChild(t),document.body.appendChild(e),e}editVideo(e){const t=this.state.playlist.findIndex(i=>i.url===e);if(t===-1)return;const s=prompt("  :",this.state.playlist[t].data.description);if(s!==null){this.state.playlist[t].data.description=s,this.updateVideoCache(t);const i=document.querySelector(`.video-item [data-url="${e}"]`).parentElement;i.querySelector("span").textContent=s||" ",this.showNotification(" !"),this.state.currentIndex===t&&this.updateDescription()}}async deleteVideo(e){try{const t=await fetch("https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/delete-video",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,telegram_id:this.state.userId})});if(!t.ok){const i=await t.text();throw new Error(`  : ${t.status} ${i}`)}this.showNotification("  !");const s=this.state.playlist.findIndex(i=>i.url===e);if(s!==-1){this.state.playlist.splice(s,1);const i=document.querySelector(`.video-item [data-url="${e}"]`);i&&i.parentElement.remove(),this.state.currentIndex===s&&(this.state.currentIndex=Math.min(this.state.currentIndex,this.state.playlist.length-1),this.loadVideo())}}catch(t){console.error("  :",t),this.showNotification(`: ${t.message}`)}}showVideoManagementList(){document.getElementById("videoManagementList").classList.toggle("visible")}hideManagementListOnClickOutside(e){const t=document.getElementById("videoManagementList");t&&t.classList.contains("visible")&&!t.contains(e.target)&&e.target!==this.userAvatar&&t.classList.remove("visible")}updateCounters(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data;this.viewCountSpan&&(this.viewCountSpan.textContent=e.views.size),this.likeCountEl&&(this.likeCountEl.textContent=e.likes),this.dislikeCountEl&&(this.dislikeCountEl.textContent=e.dislikes),this.commentCountEl&&(this.commentCountEl.textContent=e.comments.length),this.shareCountEl&&(this.shareCountEl.textContent=e.shares),this.updateRating()}calculateVideoScore(e,t){let i=e.viewTime/(e.views.size||1)/t;i>1&&(i=1+e.replays/(e.views.size||1));const r=e.likes*5+e.comments.length*10+e.shares*15+e.viewTime*.1+e.replays*20*(1+i);return Math.max(0,Math.min(5,r/50*5))}updateRating(){if(!this.state.playlist||this.state.playlist.length===0)return;const e=this.state.playlist[this.state.currentIndex].data,t=e.duration||300,s=this.calculateVideoScore(e,t),i=Math.floor(s),r=s%1>=.5?1:0,a=Math.max(0,5-i-r);this.ratingEl&&(this.ratingEl.innerHTML="".repeat(i)+(r?"":"")+"".repeat(a))}recommendNextVideo(){if(!this.state.playlist||this.state.playlist.length===0){this.state.currentIndex=0;return}const e=this.state.playlist.map((s,i)=>({index:i,score:this.calculateVideoScore(s.data,s.data.duration||300)}));if(e.length===0){this.state.currentIndex=0;return}e.sort((s,i)=>i.score-s.score);const t=e.find(s=>s.index!==this.state.currentIndex)||e[0];this.state.currentIndex=t.index}preloadNextVideo(){if(!this.state.playlist||this.state.playlist.length===0)return;this.cleanPreloadedVideos();const e=(this.state.currentIndex+1)%this.state.playlist.length;if(!this.state.preloaded.has(e)){const s=document.createElement("video");s.src=this.state.playlist[e].url,s.preload="auto",this.state.preloaded.set(e,s)}const t=(this.state.currentIndex-1+this.state.playlist.length)%this.state.playlist.length;if(!this.state.preloaded.has(t)){const s=document.createElement("video");s.src=this.state.playlist[t].url,s.preload="auto",this.state.preloaded.set(t,s)}}cleanPreloadedVideos(){const e=[this.state.currentIndex,(this.state.currentIndex+1)%this.state.playlist.length,(this.state.currentIndex-1+this.state.playlist.length)%this.state.playlist.length];for(const[t,s]of this.state.preloaded)e.includes(Number(t))||(s.src&&URL.revokeObjectURL(s.src),this.state.preloaded.delete(t))}async updateVideoCache(e){if(!this.state.playlist||this.state.playlist.length===0||e<0||e>=this.state.playlist.length)return;const t=this.state.playlist[e].data,s=this.state.playlist[e].url,i={url:s,views:Array.from(t.views),likes:t.likes,dislikes:t.dislikes,user_likes:Array.from(t.userLikes),user_dislikes:Array.from(t.userDislikes),comments:t.comments,shares:t.shares,view_time:t.viewTime,replays:t.replays,duration:t.duration,last_position:t.lastPosition,chat_messages:t.chatMessages,description:t.description};localStorage.setItem(`videoData_${s}`,JSON.stringify(i));try{const r=await fetch("https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/update-video",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!r.ok){const a=await r.text();throw new Error(`  : ${r.status} ${a}`)}}catch(r){console.error("  :",r),this.showNotification("   !")}}initializeTheme(){(localStorage.getItem("theme")||"dark")==="dark"?(document.body.classList.add("dark"),this.themeToggle.innerHTML='<i class="fas fa-sun"></i>'):(document.body.classList.remove("dark"),this.themeToggle.innerHTML='<i class="fas fa-moon"></i>')}toggleTheme(){document.body.classList.contains("dark")?(document.body.classList.remove("dark"),this.themeToggle.innerHTML='<i class="fas fa-moon"></i>',localStorage.setItem("theme","light")):(document.body.classList.add("dark"),this.themeToggle.innerHTML='<i class="fas fa-sun"></i>',localStorage.setItem("theme","dark"))}initializeTooltips(){const e=document.querySelectorAll(".tooltip");!localStorage.getItem("hasSeenTooltips")&&(e.forEach(s=>{s.classList.add("visible"),setTimeout(()=>s.classList.remove("visible"),5e3)}),localStorage.setItem("hasSeenTooltips","true"))}showNotification(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
            background: var(--notification-bg); color: var(--notification-text);
            padding: 10px 20px; border-radius: 5px; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.style.opacity="1",10),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>document.body.removeChild(t),300)},3e3)}formatTime(e){const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s<10?"0":""}${s}`}throttle(e,t){let s;return function(...i){s||(e.apply(this,i),s=!0,setTimeout(()=>s=!1,t))}}toggleVideoPlayback(){this.video.paused?this.video.play().catch(e=>console.error("Play error:",e)):this.video.pause()}handleReaction(e,t){if(t&&t.stopPropagation(),!this.state.userId){this.showNotification(",   ");return}if(!this.state.playlist||this.state.playlist.length===0)return;const s=this.state.playlist[this.state.currentIndex].data;e==="like"?s.userLikes.has(this.state.userId)?(s.userLikes.delete(this.state.userId),s.likes--):(s.userDislikes.has(this.state.userId)&&(s.userDislikes.delete(this.state.userId),s.dislikes--),s.userLikes.add(this.state.userId),s.likes++,this.showReaction("like")):e==="dislike"?s.userDislikes.has(this.state.userId)?(s.userDislikes.delete(this.state.userId),s.dislikes--):(s.userLikes.has(this.state.userId)&&(s.userLikes.delete(this.state.userId),s.likes--),s.userDislikes.add(this.state.userId),s.dislikes++,this.showReaction("dislike")):e==="comment"?(this.commentsWindow.classList.toggle("visible"),this.commentsWindow.classList.contains("visible")&&this.commentInput.focus()):e==="share"&&this.shareModal.classList.add("visible"),this.updateCounters(),this.updateVideoCache(this.state.currentIndex)}showReaction(e){this.reactionAnimation&&(this.reactionAnimation.innerHTML=e==="like"?'<i class="fas fa-thumbs-up"></i>':'<i class="fas fa-thumbs-down"></i>',this.reactionAnimation.classList.add("show"),setTimeout(()=>this.reactionAnimation.classList.remove("show"),2e3))}toggleSubmenu(e){e.stopPropagation(),this.state.isSubmenuOpen=!this.state.isSubmenuOpen,this.submenuUpload.classList.toggle("active",this.state.isSubmenuOpen),this.submenuChat.classList.toggle("active",this.state.isSubmenuOpen)}toggleReactionBarVisibility(e){e.stopPropagation(),this.reactionBar.classList.contains("visible")?(this.reactionBar.classList.remove("visible"),this.toggleReactionBar.classList.remove("active"),this.toggleReactionBar.innerHTML='<i class="fas fa-arrow-right"></i>'):(this.reactionBar.classList.add("visible"),this.toggleReactionBar.classList.add("active"),this.toggleReactionBar.innerHTML='<i class="fas fa-arrow-left"></i>',setTimeout(()=>{this.reactionBar.classList.contains("visible")&&(this.reactionBar.classList.remove("visible"),this.toggleReactionBar.classList.remove("active"),this.toggleReactionBar.innerHTML='<i class="fas fa-arrow-right"></i>')},15e3))}async downloadCurrentVideo(e){if(e.stopPropagation(),!this.state.playlist||this.state.playlist.length===0){this.showNotification("   !");return}const t=this.state.playlist[this.state.currentIndex].url;if(!t){this.showNotification("   !");return}this.uploadBtn.classList.add("downloading"),this.uploadBtn.style.setProperty("--progress","0%");try{const s=await fetch(`https://handicapped-maudie-tgclips-ca255b32.koyeb.app/api/download-video?url=${encodeURIComponent(t)}`,{mode:"cors"});if(!s.ok){const d=await s.text();throw new Error(` : ${s.status} ${d}`)}const i=Number(s.headers.get("content-length"))||0;let r=0;const a=[],o=s.body.getReader();for(;;){const{done:d,value:u}=await o.read();if(d)break;a.push(u),r+=u.length;const f=i?r/i*100:this.simulateProgress(r);this.uploadBtn.style.setProperty("--progress",`${f}%`)}const l=new Blob(a,{type:s.headers.get("content-type")||"video/mp4"}),c=window.URL.createObjectURL(l),h=document.createElement("a");h.href=c,h.download=`video_${Date.now()}.mp4`,document.body.appendChild(h),h.click(),window.URL.revokeObjectURL(c),document.body.removeChild(h),this.showNotification("  !")}catch(s){console.error(" :",s),this.showNotification(`   : ${s.message}`)}finally{this.uploadBtn.classList.remove("downloading"),this.uploadBtn.style.setProperty("--progress","0%")}}simulateProgress(e){return Math.min(100,e/(1024*1024)*10)}startDragging(e){e.preventDefault();let t=e.type==="mousedown"?e.clientY:e.touches[0].clientY,s=!0;const i=a=>{if(!s)return;(a.type==="mousemove"?a.clientY:a.touches[0].clientY)-t>50&&(this.commentsWindow.classList.remove("visible"),s=!1,document.removeEventListener("mousemove",i),document.removeEventListener("touchmove",i))},r=()=>{s=!1,document.removeEventListener("mousemove",i),document.removeEventListener("touchmove",i),document.removeEventListener("mouseup",r),document.removeEventListener("touchend",r)};document.addEventListener("mousemove",i),document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("mouseup",r),document.addEventListener("touchend",r)}handleSubmenuUpload(e){e.stopPropagation(),e.preventDefault(),this.videoUpload.click(),this.toggleSubmenu()}toggleFullscreen(e){e.stopPropagation(),e.preventDefault(),this.tg&&this.tg.requestFullscreen?this.tg.requestFullscreen().then(()=>{document.body.classList.add("telegram-fullscreen"),this.showNotification("  ")}).catch(t=>{console.error("   Telegram:",t),this.tg.expand(),this.showNotification("  ,  ")}):this.tg?this.showNotification("  "):document.fullscreenElement?document.exitFullscreen().then(()=>document.body.classList.remove("fullscreen-mode")).catch(t=>console.error("    :",t)):document.documentElement.requestFullscreen().then(()=>document.body.classList.add("fullscreen-mode")).catch(t=>{console.error("  :",t),this.showNotification("   ")})}}document.addEventListener("DOMContentLoaded",async()=>{const n=new Ci;try{await n.init(),console.log("VideoManager  ")}catch(e){console.error("  VideoManager:",e),n.showNotification("  ")}});export{Lt as g};
